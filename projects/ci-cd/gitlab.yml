gitlab:
  image: gitlab/gitlab-ce:15.3.3-ce.0
  container_name: gitlab
  hostname: gitlab.${SERVER_NAME}
  environment:
    GITLAB_SKIP_UNMIGRATED_DATA_CHECK: 'true'
    GITLAB_OMNIBUS_CONFIG: |
      postgresql['enable'] = true
      external_url 'http://gitlab.${SERVER_NAME}:81'
      gitlab_rails['initial_root_password'] = '${GITLAB_ROOT_PASS}'
      gitlab_rails['backup_keep_time'] = 2419200
      gitlab_rails['trusted_proxies'] = ['172.18.0.0/16','172.20.0.0/16']
      nginx['real_ip_trusted_addresses'] = ['172.18.0.0/16','172.20.0.0/16']
      nginx['real_ip_header'] = 'X-Real-Ip'
      nginx['real_ip_recursive'] = 'on'
      nginx['listen_port'] = 80
  networks:
    - gitlab
  volumes:
    - /etc/localtime:/etc/localtime:ro
    - ${VOLUMES}/gitlab/config:/etc/gitlab
    - ${VOLUMES}/gitlab/logs:/var/log/gitlab
    - ${VOLUMES}/gitlab/backup:/var/opt/gitlab/backups
  restart: unless-stopped
  labels:
    - "traefik.enable=true"
    - "traefik.http.routers.gitlab.entrypoints=internal"
    - "traefik.http.routers.gitlab.rule=Host(`gitlab.${SERVER_NAME}`)"
    - "traefik.http.services.gitlab.loadbalancer.server.port=80"
gitlab-runner:
  container_name: gitlab-runner
  image: gitlab/gitlab-runner:alpine
  networks:
    - gitlab
  ports:
    - 8093:8093
  volumes:
    - /var/run/docker.sock:/var/run/docker.sock
    - /etc/localtime:/etc/localtime:ro
    - ${VOLUMES}/gitlab-runner:/etc/gitlab-runner
  restart: unless-stopped
